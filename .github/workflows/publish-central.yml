name: Publish to Maven Central

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
      CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
      MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 8 + Maven settings
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "8"
          cache: maven
          # central-publishing-maven-plugin 使用 publishingServerId=central
          server-id: central
          server-username: CENTRAL_USERNAME
          server-password: CENTRAL_PASSWORD

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent || true
          gpgconf --launch gpg-agent || true

          if printf '%s' "$GPG_PRIVATE_KEY" | grep -q "BEGIN PGP PRIVATE KEY BLOCK"; then
            printf '%s' "$GPG_PRIVATE_KEY" | gpg --batch --import
          else
            printf '%s' "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --import
          fi

          gpg --batch --list-secret-keys --keyid-format LONG
          GPG_KEY_ID="$(gpg --batch --with-colons --list-secret-keys | awk -F: '/^sec:/ {print $5; exit}')"
          if [ -z "$GPG_KEY_ID" ]; then
            echo "gpg: no secret key imported" >&2
            exit 1
          fi
          echo "GPG_KEY_ID=$GPG_KEY_ID" >> "$GITHUB_ENV"

      - name: Publish
        run: mvn -DperformRelease=true -DskipTests -DautoPublish=true -Dgpg.keyname="${GPG_KEY_ID}" clean deploy
